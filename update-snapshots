#! /bin/sh
PATH=/usr/local/bin:/usr/bin:/bin
d=`date -u +%Y%m%d%H%M`
t=/local/php/web/snaps/;

fetch_index ( ) {
  cd /local/repository/systems
  git fetch --quiet;
  git reset --quiet --hard origin/master;
  cd /local/repository/php-src;
  git fetch --quiet;
}

do_update ( ) {
  prefix=$1
  branch=$2

  source=/local/repository/php-src
  target=$1-$d

  cd $source
  git checkout --quiet origin/$branch

  cd /dev/shm || exit 1
  cp -rp $source $target
  rm -rf $target/.git $target/.deps $target/ChangeLog*
  (cd $target && ./buildconf --force --copy && ./genfiles) >/dev/null 2>&1
  rm -f $target/buildmk.stamp
  f=$target.tar
  tar cf $f $target
  rm -rf $target
  gzip -c5 < $f > $f.gz
  bzip2 -5 < $f > $f.bz2
  xz -9 < $f > $f.xz;
  rm -f $f
  mv $f* $t

  (cd $t; ln -sf $f.gz $prefix-latest.tar.gz; ln -sf $f.bz2 $prefix-latest.tar.bz2; ln -sf $f.xz $prefix-latest.tar.xz;)
}

fetch_index
do_update php-master master
do_update php5.3 PHP-5.3
do_update php5.4 PHP-5.4
do_update php5.5 PHP-5.5
do_update php5.6 PHP-5.6

# purge files which are older than 12 hours
find $t -name \*tar\* -mmin +540|xargs rm -rf
