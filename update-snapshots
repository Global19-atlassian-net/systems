#! /bin/sh
PATH=/usr/local/bin:/usr/bin:/bin
d=`date -u +%Y%m%d%H%M`
t=/local/sites/snaps.php.net/www

fetch_index ( ) {
  cd /local/repository/systems
  svn up -q >/dev/null
}

do_update ( ) {
  prefix=$1
  
  source=/local/repository/$1
  target=$1-$d

  cd $source
  svn up -q >/dev/null

  cd /dev/shm || exit 1
  cp -rp $source $target
  find $target -name .svn -o -name .cvsignore | xargs rm -rf
  rm -f $target/.deps $target/ChangeLog*
  (cd $target && ./buildconf --force --copy && ./genfiles) >/dev/null 2>&1
  rm -f $target/buildmk.stamp
  f=$target.tar
  tar cf $f $target
  rm -rf $target
  gzip -c9 < $f > $f.gz
  bzip2 -9 < $f > $f.bz2
  rm -f $f
  mv $f* $t

  (cd $t; ln -sf $f.gz $prefix-latest.tar.gz; ln -sf $f.bz2 $prefix-latest.tar.bz2)
}

fetch_index
do_update php-trunk
do_update php5.3

# purge files which are older than 12 hours
find $t -name \*tar\* -mmin +540|xargs rm -rf
